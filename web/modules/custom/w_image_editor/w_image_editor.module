<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Ajax\AjaxResponse;
use Drupal\Core\Ajax\HtmlCommand;
use Symfony\Component\HttpFoundation\Request;
use Drupal\file\Element\ManagedFile;

/**
 * Implements hook_form_alter().
 */
function w_image_editor_form_alter(array &$form, FormStateInterface $form_state, $form_id) {

    $form['#attached']['library'][] = 'w_image_editor/global';

}

/**
 * After-build callback for managed_file elements.
 *
 * Runs after ManagedFile::processManagedFile(), so upload_button exists here.
 */
function w_image_editor_managed_file_after_build(array $element, FormStateInterface $form_state) {

  \Drupal::logger('w_image_editor')->notice('after_build: keys=@keys type=@type', [
    '@keys' => implode(',', array_keys($element)),
    '@type' => $element['#type'] ?? 'n/a',
  ]);

  if (!isset($element['upload_button']['#ajax'])) {
    // If it's not showing up, this isn't the classic managed_file upload UI
    // (e.g. Media Library widget), or it's configured differently.
    return $element;
  }

  // Override the AJAX callback.
  $element['upload_button']['#ajax']['callback'] = 'w_image_editor_managed_file_upload_callback';

  // Pass our target selector through.
  $element['upload_button']['#ajax']['w_image_editor_target_selector'] = $element['#w_image_editor_target_selector'] ?? NULL;

  return $element;
}

function w_image_editor_managed_file_upload_callback(array &$form, FormStateInterface $form_state, Request $request) {
  // Let core handle the upload + widget refresh.
  $response = ManagedFile::uploadAjaxCallback($form, $form_state, $request);

  // Add our custom markup update.
  $trigger = $form_state->getTriggeringElement();
  $target = $trigger['#ajax']['w_image_editor_target_selector'] ?? NULL;

  if ($target) {
    $markup = '<div class="messages messages--status">âœ… Image uploaded!</div>';
    $response->addCommand(new HtmlCommand($target, $markup));
  }

  return $response;
}

function w_image_editor_preprocess_field(array &$variables): void {
  // Only act on the paragraph image field you care about.
  if (
    ($variables['element']['#entity_type'] ?? NULL) === 'paragraph' &&
    ($variables['element']['#field_name'] ?? NULL) === 'field_image'
  ) {
    // If field has values, add a div after each rendered item.
    if (!empty($variables['items'])) {
      foreach ($variables['items'] as $delta => &$item) {
        // Append markup after the image render array.
        $item['content']['#suffix'] = ($item['content']['#suffix'] ?? '')
          . '<div class="after-image-area" data-delta="' . $delta . '"></div>';
      }
    }
  }
}

/*
 * Implements hook_theme_suggestions_HOOK_alter()
 */
function w_image_editor_theme_suggestions_fieldset_alter(array &$suggestions, array $variables) {
  $suggestions[] = 'fieldset__' . $variables['element']['#parents'][0];
}
