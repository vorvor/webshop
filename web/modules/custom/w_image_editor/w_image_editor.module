<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Ajax\AjaxResponse;
use Drupal\Core\Ajax\HtmlCommand;
use Drupal\file\Entity\File;
use Drupal\image\Entity\ImageStyle;
use Drupal\node\NodeInterface;
use Symfony\Component\HttpFoundation\Request;
use Drupal\file\Element\ManagedFile;

/**
 * Implements hook_form_alter().
 */
function w_image_editor_form_alter(array &$form, FormStateInterface $form_state, $form_id) {

    $form['#attached']['library'][] = 'w_image_editor/global';

}

/**
 * After-build callback for managed_file elements.
 *
 * Runs after ManagedFile::processManagedFile(), so upload_button exists here.
 */
function w_image_editor_managed_file_after_build(array $element, FormStateInterface $form_state) {

  \Drupal::logger('w_image_editor')->notice('after_build: keys=@keys type=@type', [
    '@keys' => implode(',', array_keys($element)),
    '@type' => $element['#type'] ?? 'n/a',
  ]);

  if (!isset($element['upload_button']['#ajax'])) {
    // If it's not showing up, this isn't the classic managed_file upload UI
    // (e.g. Media Library widget), or it's configured differently.
    return $element;
  }

  // Override the AJAX callback.
  $element['upload_button']['#ajax']['callback'] = 'w_image_editor_managed_file_upload_callback';

  // Pass our target selector through.
  $element['upload_button']['#ajax']['w_image_editor_target_selector'] = $element['#w_image_editor_target_selector'] ?? NULL;

  return $element;
}

function w_image_editor_managed_file_upload_callback(array &$form, FormStateInterface $form_state, Request $request) {
  // Let core handle the upload + widget refresh.
  $response = ManagedFile::uploadAjaxCallback($form, $form_state, $request);

  // Add our custom markup update.
  $trigger = $form_state->getTriggeringElement();
  $target = $trigger['#ajax']['w_image_editor_target_selector'] ?? NULL;

  if ($target) {
    $markup = '<div class="messages messages--status">âœ… Image uploaded!</div>';
    $response->addCommand(new HtmlCommand($target, $markup));
  }

  return $response;
}

function w_image_editor_preprocess_field(array &$variables): void {
  // Only act on the paragraph image field you care about.
  if (
    ($variables['element']['#entity_type'] ?? NULL) === 'paragraph' &&
    ($variables['element']['#field_name'] ?? NULL) === 'field_image'
  ) {
    // If field has values, add a div after each rendered item.
    if (!empty($variables['items'])) {
      foreach ($variables['items'] as $delta => &$item) {
        // Append markup after the image render array.
        $item['content']['#suffix'] = ($item['content']['#suffix'] ?? '')
          . '<div class="after-image-area" data-delta="' . $delta . '"></div>';
      }
    }
  }
}

/*
 * Implements hook_theme_suggestions_HOOK_alter()
 */
function w_image_editor_theme_suggestions_fieldset_alter(array &$suggestions, array $variables) {
  $name = 'fieldset__' . $variables['element']['#parents'][0];
  $bundle = '';
  if (isset($variables['element']['#target_bundles'])) {
    $bundle = reset($variables['element']['#target_bundles']);
    $name .= '_' . $bundle;
  }

  $suggestions[] = $name;
}

/**
 * Implements hook_preprocess_node().
 */
function w_image_editor_preprocess_node(array &$variables): void {
  $node = $variables['node'] ?? NULL;
  if (!$node instanceof NodeInterface || $node->bundle() !== 'order') {
    return;
  }

  // Only on the full node page.
  if (($variables['view_mode'] ?? '') !== 'full') {
    return;
  }

  $sides = ['front', 'back', 'side'];

  $scale = $node->get('field_image_placement_front')->entity->get('field_scale')->getValue()[0]['value'];
  $left = $node->get('field_image_placement_front')->entity->get('field_left')->getValue()[0]['value'];
  $top = $node->get('field_image_placement_front')->entity->get('field_top')->getValue()[0]['value'];
  $rotation = $node->get('field_image_placement_front')->entity->get('field_rotation')->getValue()[0]['value'];
  $image = $node->get('field_image_placement_front')
    ->entity->get('field_image')
    ->entity->get('field_media_image')->getValue()[0];
  $width = $image['width'];
  $height = $image['height'];

  $file = File::load($image['target_id']);
  $dimensions = w_image_editor_get_styled_dimensions('media_library', $file);

  // Image positioning in fabric is by center of the image.
  $top = $top - ($dimensions['height'] * $scale / 2);
  $left = $left - ($dimensions['width'] * $scale / 2);

  $variables['#attached']['library'][] = 'w_image_editor/image-placement-product-page';
  $variables['#attributes'] = $variables['#attributes'] ?? [];
  $existing = $variables['#attributes']['style'] ?? '';
  $style = trim($existing . ' ' . "--field-image-front-scale: {$scale};");
  $style .= " --field-image-front-left: {$left}px; --field-image-front-top: {$top}px; --field-image-front-rotation: {$rotation};";
  $variables['attributes']['style'] = $style;


}

function w_image_editor_get_styled_dimensions(string $style_name, File $file): ?array {
  $style = ImageStyle::load($style_name);
  if (!$style) {
    return NULL;
  }

  $uri = $file->getFileUri();

  // Read original dimensions.
  /** @var \Drupal\Core\Image\ImageFactory $image_factory */
  $image_factory = \Drupal::service('image.factory');
  $image = $image_factory->get($uri);
  if (!$image->isValid()) {
    return NULL;
  }

  $dimensions = [
    'width' => $image->getWidth(),
    'height' => $image->getHeight(),
  ];

  // Simulate the image style effects (incl. "upscale" behavior).
  $style->transformDimensions($dimensions, $uri);

  return $dimensions; // ['width' => ..., 'height' => ...]
}
