<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\node\NodeInterface;

/**
 * Implements hook_form_FORM_ID_alter().
 * Example: article node form + field_colors taxonomy term reference.
 */
function w_select_with_image_form_node_order_form_alter(array &$form, FormStateInterface $form_state) {
  $el =& $form['field_order_options']['widget'][0]['subform']['field_color']['widget'];
  $el['#attributes']['class'][] = 'js-color-select2';

  $hexCodes = [];
  if (!empty($el['#options']) && is_array($el['#options'])) {
    $tids = array_filter(array_keys($el['#options']), 'is_numeric');
    if ($tids) {
      /** @var \Drupal\taxonomy\TermStorageInterface $storage */
      $storage = \Drupal::entityTypeManager()->getStorage('taxonomy_term');
      $terms = $storage->loadMultiple($tids);

      foreach ($terms as $tid => $term) {
        $hex = $term->get('field_color_hex')->value ?? '';
        if ($hex) {
          $el['#option_attributes'][$tid]['data-color'] = $hex;
          $hexCodes[$tid] = $hex;
        }
      }
    }

    $route_match = \Drupal::routeMatch();
    $nid = $route_match->getParameter('node');
    if ($nid instanceof NodeInterface) {
      $nid = $nid->id();
    }
    $nid = is_numeric($nid) ? (int) $nid : null;
    $product = \Drupal::entityTypeManager()->getStorage('node')->load($nid);
    $colors = $product->get('field_available_colors')->getValue();

    foreach ($el['#options'] as $tid => $option) {
      if (!in_array($tid, array_column($colors, 'target_id'))) {
        unset($el['#options'][$tid]);
      }
    }
  }

  $form['#attached']['library'][] = 'w_select_with_image/color_select2';
  $form['#attached']['drupalSettings']['colorSelect2'] = $hexCodes;
}
