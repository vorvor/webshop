<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Fabric.js drag/rotate/scale example</title>
  <style>
    body { font-family: system-ui, sans-serif; }
    #wrap { width: 300px; margin: 20px auto; background-image: url('shirt-back.jpg'); }
    canvas { border: 1px solid #ddd; }

    /* Simple on-screen readout */
    #hud {
      position: fixed;
      left: 12px;
      top: 12px;
      z-index: 9999;
      background: rgba(0,0,0,0.75);
      color: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      font: 13px/1.35 system-ui, sans-serif;
      min-width: 220px;
      user-select: none;
      pointer-events: none;
      white-space: pre;
    }
    #hud b { font-weight: 700; }
  </style>
</head>
<body>

<div id="hud">Waiting…</div>
<input id="rotation" type="text" value="0">

<div id="wrap">
  <canvas id="c" width="300" height="300"></canvas>
</div>

<!-- Fabric.js (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/fabric@latest/dist/index.min.js"></script>
<script>
  const canvas = new fabric.Canvas('c', {
    centeredScaling: false,
    centeredRotation: true,
    uniformScaling: true,
    lockUniScaling: true
  });

  const hudEl = document.getElementById('hud');

  // We’ll store the "start" state of the active object when user begins an action
  let startState = null;

  function fmt(n, digits = 2) {
    return Number(n).toFixed(digits);
  }

  function captureStartState(obj) {
    if (!obj) return;
    startState = {
      left: obj.left ?? 0,
      top: obj.top ?? 0,
      scaleX: obj.scaleX ?? 1,
      scaleY: obj.scaleY ?? 1,
      angle: obj.angle ?? 0
    };
  }

  function updateHUD(obj) {
    if (!obj) {
      hudEl.textContent = 'No active object';
      return;
    }

    // Ensure Fabric has updated coords (useful during interactions)
    obj.setCoords();

    const left = obj.left ?? 0;
    const top = obj.top ?? 0;
    const angle = obj.angle ?? 0;
    const scaleX = obj.scaleX ?? 1;
    const scaleY = obj.scaleY ?? 1;

    let dx = 0, dy = 0, dAngle = 0, dScaleX = 0, dScaleY = 0;
    if (startState) {
      dx = left - startState.left;
      dy = top - startState.top;
      dAngle = angle - startState.angle;
      dScaleX = scaleX - startState.scaleX;
      dScaleY = scaleY - startState.scaleY;
    }

    hudEl.textContent =
      `x (left):   ${fmt(left, 1)}
y (top):    ${fmt(top, 1)}
rotation:   ${fmt(angle, 1)}°
scaleX:     ${fmt(scaleX, 3)}
scaleY:     ${fmt(scaleY, 3)}

Δx:         ${fmt(dx, 1)}
Δy:         ${fmt(dy, 1)}
Δrot:       ${fmt(dAngle, 1)}°
ΔscaleX:    ${fmt(dScaleX, 3)}
ΔscaleY:    ${fmt(dScaleY, 3)}`;

    document.getElementById("rotation").value = angle;

  }

  // Update HUD for whichever object is active
  function updateFromActive() {
    updateHUD(canvas.getActiveObject());
  }

  // Capture start state when user presses mouse down on an object
  canvas.on('mouse:down', (e) => {
    if (e.target) {
      captureStartState(e.target);
      updateHUD(e.target);
    }
  });

  // Live updates while transforming
  canvas.on('object:moving',   (e) => updateHUD(e.target));
  canvas.on('object:scaling',  (e) => updateHUD(e.target));
  canvas.on('object:rotating', (e) => updateHUD(e.target));

  // Also update when selection changes
  canvas.on('selection:created', updateFromActive);
  canvas.on('selection:updated', updateFromActive);
  canvas.on('selection:cleared', () => updateHUD(null));

  // Optional: when user releases mouse, reset startState (so Δ values are per-gesture)
  canvas.on('mouse:up', () => {
    // keep the HUD showing final values, but clear deltas for the next gesture
    startState = null;
    updateFromActive();
  });

  // ----------------------------
  // 2) FOREGROUND (your existing functionality)
  // ----------------------------
  const url = 'eagle-small.png';
  console.log('Loading FOREGROUND:', url);

  const htmlImg = new Image();
  htmlImg.crossOrigin = 'anonymous';

  htmlImg.onload = () => {
    console.log('✅ Foreground loaded:', htmlImg.naturalWidth, htmlImg.naturalHeight);

    const fabImg = new fabric.Image(htmlImg, {
      left: 100,
      top: 100,
      cornerStyle: 'circle',
      cornerStrokeColor: 'blue',
      cornerColor: 'lightblue',
      padding: 10,
      transparentCorners: false,
      cornerDashArray: [2, 2],
      borderColor: 'orange',
      borderDashArray: [3, 1, 3],
      borderScaleFactor: 2,
    });

    fabImg.setControlsVisibility({
      mt: false,
      mb: false,
      ml: false,
      mr: false,
      // mtr: false
    });

    canvas.add(fabImg);
    canvas.setActiveObject(fabImg);
    canvas.requestRenderAll();

    // Initialize HUD immediately
    captureStartState(fabImg);
    updateHUD(fabImg);
    startState = null; // so Δ starts at 0 until first gesture
  };

  htmlImg.onerror = (e) => {
    console.error('❌ Foreground failed to load:', url, e);
    alert('Foreground failed to load: ' + url + '\nCheck Network tab for 404 / blocked request.');
  };

  htmlImg.src = url;
</script>
</body>
</html>
